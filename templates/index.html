<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mist Organization Licensing Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --magenta: #E20074;
            --magenta-dark: #B8005D;
            --magenta-light: #FF1493;
        }
        
        body {
            background-color: #1a1a2e;
            min-height: 100vh;
        }
        
        .navbar {
            background-color: #16213e !important;
            border-bottom: 2px solid var(--magenta);
        }
        
        .navbar-brand {
            color: var(--magenta) !important;
            font-weight: bold;
        }
        
        .btn-magenta {
            background-color: var(--magenta);
            border-color: var(--magenta);
            color: white;
        }
        
        .btn-magenta:hover {
            background-color: var(--magenta-dark);
            border-color: var(--magenta-dark);
            color: white;
        }
        
        .btn-outline-magenta {
            border-color: var(--magenta);
            color: var(--magenta);
        }
        
        .btn-outline-magenta:hover {
            background-color: var(--magenta);
            color: white;
        }
        
        .card {
            background-color: #16213e;
            border: 1px solid #2a2a4a;
        }
        
        .card-header {
            background-color: #1a1a3e;
            border-bottom: 1px solid var(--magenta);
        }
        
        .table {
            --bs-table-bg: transparent;
        }
        
        .table thead th {
            background-color: #1a1a3e;
            border-bottom: 2px solid var(--magenta);
            color: var(--magenta);
        }
        
        .org-checkbox {
            accent-color: var(--magenta);
        }
        
        .spinner-magenta {
            color: var(--magenta);
        }
        
        .license-card {
            transition: transform 0.2s;
        }
        
        .license-card:hover {
            transform: translateY(-2px);
        }
        
        .badge-magenta {
            background-color: var(--magenta);
        }
        
        .progress-bar-magenta {
            background-color: var(--magenta);
        }
        
        .text-magenta {
            color: var(--magenta) !important;
        }
        
        .border-magenta {
            border-color: var(--magenta) !important;
        }
        
        #orgList .list-group-item {
            background-color: #16213e;
            border-color: #2a2a4a;
            cursor: pointer;
        }
        
        #orgList .list-group-item:hover {
            background-color: #1a1a3e;
        }
        
        #orgList .list-group-item.selected {
            border-left: 3px solid var(--magenta);
            background-color: #1a1a3e;
        }
        
        .comparison-table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .license-type-header {
            background-color: var(--magenta) !important;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-key-fill me-2"></i>Mist Org Licensing Comparison
            </a>
            <div class="d-flex align-items-center">
                <span id="connectionStatus" class="badge bg-secondary me-3">
                    <i class="bi bi-circle-fill me-1"></i>Connecting...
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Organization Selection Panel -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-building me-2"></i>Organizations</h5>
                        <button class="btn btn-sm btn-outline-magenta" onclick="refreshOrganizations()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="orgLoading" class="text-center py-4">
                            <div class="spinner-border spinner-magenta" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading organizations...</p>
                        </div>
                        <div id="orgList" class="list-group list-group-flush d-none">
                            <!-- Organizations populated here -->
                        </div>
                        <div id="orgError" class="alert alert-danger d-none">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="orgErrorMessage"></span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button id="compareBtn" class="btn btn-magenta w-100" onclick="compareSelected()" disabled>
                            <i class="bi bi-bar-chart-fill me-2"></i>Compare Selected (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Comparison Results Panel -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>License Comparison</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-light me-2" onclick="exportCSV()" id="exportBtn" disabled>
                                <i class="bi bi-download me-1"></i>Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="comparisonPlaceholder" class="text-center py-5 text-muted">
                            <i class="bi bi-arrow-left-circle display-4"></i>
                            <p class="mt-3">Select organizations from the left panel and click "Compare Selected" to view licensing comparison.</p>
                        </div>
                        <div id="comparisonLoading" class="text-center py-5 d-none">
                            <div class="spinner-border spinner-magenta" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Fetching license data...</p>
                        </div>
                        <div id="comparisonResults" class="d-none">
                            <div class="table-responsive">
                                <table class="table table-hover comparison-table" id="comparisonTable">
                                    <thead>
                                        <tr id="tableHeader">
                                            <!-- Headers populated dynamically -->
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <!-- Data populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="comparisonError" class="alert alert-danger d-none">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="comparisonErrorMessage"></span>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div id="summaryCards" class="row mt-4 d-none">
                    <!-- Summary cards populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State
        let organizations = [];
        let selectedOrgs = new Set();
        let comparisonData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshOrganizations();
        });

        // Fetch organizations
        async function refreshOrganizations() {
            document.getElementById('orgLoading').classList.remove('d-none');
            document.getElementById('orgList').classList.add('d-none');
            document.getElementById('orgError').classList.add('d-none');
            
            try {
                const response = await fetch('/api/organizations');
                const result = await response.json();
                
                if (result.success) {
                    organizations = result.data;
                    renderOrganizations();
                    updateConnectionStatus(true);
                } else {
                    throw new Error(result.error || 'Failed to fetch organizations');
                }
            } catch (error) {
                console.error('Error fetching organizations:', error);
                document.getElementById('orgErrorMessage').textContent = error.message;
                document.getElementById('orgError').classList.remove('d-none');
                updateConnectionStatus(false);
            } finally {
                document.getElementById('orgLoading').classList.add('d-none');
            }
        }

        // Render organization list
        function renderOrganizations() {
            const list = document.getElementById('orgList');
            list.innerHTML = '';
            
            organizations.forEach(org => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.dataset.orgId = org.id;
                
                item.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input org-checkbox" type="checkbox" 
                               id="org-${org.id}" onchange="toggleOrg('${org.id}')">
                        <label class="form-check-label" for="org-${org.id}">
                            ${org.name}
                        </label>
                    </div>
                    <span class="badge bg-secondary">${org.role}</span>
                `;
                
                item.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        toggleOrg(org.id);
                    }
                });
                
                list.appendChild(item);
            });
            
            list.classList.remove('d-none');
        }

        // Toggle organization selection
        function toggleOrg(orgId) {
            const item = document.querySelector(`[data-org-id="${orgId}"]`);
            const checkbox = document.getElementById(`org-${orgId}`);
            
            if (checkbox.checked) {
                selectedOrgs.add(orgId);
                item.classList.add('selected');
            } else {
                selectedOrgs.delete(orgId);
                item.classList.remove('selected');
            }
            
            updateSelectedCount();
        }

        // Update selected count
        function updateSelectedCount() {
            const count = selectedOrgs.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('compareBtn').disabled = count < 1;
        }

        // Compare selected organizations
        async function compareSelected() {
            if (selectedOrgs.size === 0) return;
            
            document.getElementById('comparisonPlaceholder').classList.add('d-none');
            document.getElementById('comparisonLoading').classList.remove('d-none');
            document.getElementById('comparisonResults').classList.add('d-none');
            document.getElementById('comparisonError').classList.add('d-none');
            document.getElementById('summaryCards').classList.add('d-none');
            
            try {
                const response = await fetch('/api/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ org_ids: Array.from(selectedOrgs) })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    comparisonData = result.data;
                    renderComparison();
                    document.getElementById('exportBtn').disabled = false;
                } else {
                    throw new Error(result.error || 'Failed to compare organizations');
                }
            } catch (error) {
                console.error('Error comparing organizations:', error);
                document.getElementById('comparisonErrorMessage').textContent = error.message;
                document.getElementById('comparisonError').classList.remove('d-none');
            } finally {
                document.getElementById('comparisonLoading').classList.add('d-none');
            }
        }

        // Render comparison table
        function renderComparison() {
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            
            // Build header
            header.innerHTML = '<th>Metric</th>';
            comparisonData.forEach(org => {
                header.innerHTML += `<th>${org.org_name}</th>`;
            });
            
            // Build body
            body.innerHTML = '';
            
            // Inventory section
            const inventoryRows = [
                { key: 'aps', label: 'Access Points' },
                { key: 'switches', label: 'Switches' },
                { key: 'gateways', label: 'Gateways' },
                { key: 'total', label: 'Total Devices' }
            ];
            
            // Add inventory header
            body.innerHTML += `<tr class="license-type-header"><td colspan="${comparisonData.length + 1}"><strong>Device Inventory</strong></td></tr>`;
            
            inventoryRows.forEach(row => {
                let tr = `<tr><td>${row.label}</td>`;
                comparisonData.forEach(org => {
                    const value = org.inventory ? (org.inventory[row.key] || 0).toLocaleString() : '-';
                    tr += `<td>${value}</td>`;
                });
                tr += '</tr>';
                body.innerHTML += tr;
            });
            
            // Add license summary header
            body.innerHTML += `<tr class="license-type-header"><td colspan="${comparisonData.length + 1}"><strong>License Summary (Entitled / Used)</strong></td></tr>`;
            
            // Collect all license types from entitled and summary
            const licenseTypes = new Set();
            comparisonData.forEach(org => {
                if (org.licenses) {
                    if (org.licenses.entitled) {
                        Object.keys(org.licenses.entitled).forEach(key => licenseTypes.add(key));
                    }
                    if (org.licenses.summary) {
                        Object.keys(org.licenses.summary).forEach(key => licenseTypes.add(key));
                    }
                }
            });
            
            // Sort license types alphabetically
            const sortedLicenseTypes = Array.from(licenseTypes).sort();
            
            // License summary rows
            sortedLicenseTypes.forEach(licType => {
                let tr = `<tr><td>${licType}</td>`;
                comparisonData.forEach(org => {
                    let value = '-';
                    if (org.licenses) {
                        const entitled = (org.licenses.entitled && org.licenses.entitled[licType]) || 0;
                        const used = (org.licenses.summary && org.licenses.summary[licType]) || 0;
                        if (entitled > 0 || used > 0) {
                            value = `${entitled.toLocaleString()} / ${used.toLocaleString()}`;
                        }
                    }
                    tr += `<td>${value}</td>`;
                });
                tr += '</tr>';
                body.innerHTML += tr;
            });
            
            document.getElementById('comparisonResults').classList.remove('d-none');
            renderSummaryCards();
        }

        // Render summary cards
        function renderSummaryCards() {
            const container = document.getElementById('summaryCards');
            container.innerHTML = '';
            
            let totalAPs = 0, totalSwitches = 0, totalGateways = 0;
            
            comparisonData.forEach(org => {
                if (org.inventory) {
                    totalAPs += org.inventory.aps || 0;
                    totalSwitches += org.inventory.switches || 0;
                    totalGateways += org.inventory.gateways || 0;
                }
            });
            
            const cards = [
                { label: 'Total APs', value: totalAPs, icon: 'bi-wifi' },
                { label: 'Total Switches', value: totalSwitches, icon: 'bi-hdd-stack' },
                { label: 'Total Gateways', value: totalGateways, icon: 'bi-router' },
                { label: 'Organizations', value: comparisonData.length, icon: 'bi-building' }
            ];
            
            cards.forEach(card => {
                container.innerHTML += `
                    <div class="col-md-3">
                        <div class="card license-card">
                            <div class="card-body text-center">
                                <i class="bi ${card.icon} display-4 text-magenta"></i>
                                <h2 class="mt-2">${card.value.toLocaleString()}</h2>
                                <p class="text-muted mb-0">${card.label}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.classList.remove('d-none');
        }

        // Export to CSV
        function exportCSV() {
            if (comparisonData.length === 0) return;
            
            let csv = 'Metric,' + comparisonData.map(o => `"${o.org_name}"`).join(',') + '\n';
            
            // Inventory
            ['aps', 'switches', 'gateways', 'total'].forEach(key => {
                const label = key.charAt(0).toUpperCase() + key.slice(1);
                csv += label + ',' + comparisonData.map(o => o.inventory ? (o.inventory[key] || 0) : '').join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mist_license_comparison_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'badge bg-success me-3';
                status.innerHTML = '<i class="bi bi-circle-fill me-1"></i>Connected';
            } else {
                status.className = 'badge bg-danger me-3';
                status.innerHTML = '<i class="bi bi-circle-fill me-1"></i>Disconnected';
            }
        }
    </script>
</body>
</html>
