<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mist Organization Licensing Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --tmobile-magenta: #E20074;
            --tmobile-magenta-hover: #C00062;
        }
        
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        .navbar {
            background-color: #2d2d2d !important;
            border-bottom: 3px solid var(--tmobile-magenta);
        }
        
        .navbar-brand {
            color: var(--tmobile-magenta) !important;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: var(--tmobile-magenta);
            border-color: var(--tmobile-magenta);
        }
        
        .btn-primary:hover {
            background-color: var(--tmobile-magenta-hover);
            border-color: var(--tmobile-magenta-hover);
        }
        
        .btn-magenta {
            background-color: var(--tmobile-magenta);
            border-color: var(--tmobile-magenta);
            color: white;
        }
        
        .btn-magenta:hover {
            background-color: var(--tmobile-magenta-hover);
            border-color: var(--tmobile-magenta-hover);
            color: white;
        }
        
        .btn-outline-magenta {
            border-color: var(--tmobile-magenta);
            color: var(--tmobile-magenta);
        }
        
        .btn-outline-magenta:hover {
            background-color: var(--tmobile-magenta);
            color: white;
        }
        
        .card {
            background-color: #2d2d2d;
            border: 1px solid #404040;
        }
        
        .card-header {
            background-color: #363636;
            border-bottom: 2px solid var(--tmobile-magenta);
            font-weight: 600;
        }
        
        .table {
            color: #e0e0e0;
            --bs-table-bg: transparent;
        }
        
        .table-hover tbody tr:hover {
            background-color: #363636;
        }
        
        .table thead th {
            background-color: #363636;
            border-bottom: 2px solid var(--tmobile-magenta);
            color: var(--tmobile-magenta);
        }
        
        .org-checkbox {
            accent-color: var(--tmobile-magenta);
        }
        
        .spinner-border {
            color: var(--tmobile-magenta);
        }
        
        .spinner-magenta {
            color: var(--tmobile-magenta);
        }
        
        .license-card {
            transition: transform 0.2s;
        }
        
        .license-card:hover {
            transform: translateY(-2px);
        }
        
        .badge-magenta {
            background-color: var(--tmobile-magenta);
        }
        
        .progress-bar-magenta {
            background-color: var(--tmobile-magenta);
        }
        
        .text-magenta {
            color: var(--tmobile-magenta) !important;
        }
        
        .border-magenta {
            border-color: var(--tmobile-magenta) !important;
        }
        
        #orgList .list-group-item {
            background-color: #2d2d2d;
            border-color: #404040;
            cursor: pointer;
        }
        
        #orgList .list-group-item:hover {
            background-color: #363636;
        }
        
        #orgList .list-group-item.selected {
            border-left: 3px solid var(--tmobile-magenta);
            background-color: #363636;
        }
        
        .comparison-table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .license-type-header {
            background-color: var(--tmobile-magenta) !important;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-key-fill me-2"></i>Mist Org Licensing Comparison
            </a>
            <div class="d-flex align-items-center">
                <span id="connectionStatus" class="badge bg-secondary me-3">
                    <i class="bi bi-circle-fill me-1"></i>Connecting...
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Organization Selection Panel - Full Width Above -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-building me-2"></i>Organizations</h5>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-light me-2" onclick="selectAllOrgs()">
                                <i class="bi bi-check-all me-1"></i>Select All
                            </button>
                            <button id="compareBtn" class="btn btn-magenta me-2" onclick="compareSelected()" disabled>
                                <i class="bi bi-bar-chart-fill me-2"></i>Compare Selected (<span id="selectedCount">0</span>)
                            </button>
                            <button class="btn btn-sm btn-outline-magenta" onclick="refreshOrganizations()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <div id="orgLoading" class="text-center py-3">
                            <div class="spinner-border spinner-magenta" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2 text-muted">Loading organizations...</span>
                        </div>
                        <div id="orgList" class="d-none" style="display: flex !important; flex-wrap: wrap; gap: 0.5rem;">
                            <!-- Organizations populated here as inline badges/buttons -->
                        </div>
                        <div id="orgError" class="alert alert-danger d-none mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="orgErrorMessage"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Results Panel - Full Width Below -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>License Comparison</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-magenta me-2" onclick="addManualOrgRow()" id="addManualBtn">
                                <i class="bi bi-plus-circle me-1"></i>Add Manual Org
                            </button>
                            <button class="btn btn-sm btn-outline-light me-2" onclick="exportCSV()" id="exportBtn" disabled>
                                <i class="bi bi-download me-1"></i>Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="comparisonPlaceholder" class="text-center py-5 text-muted">
                            <i class="bi bi-arrow-left-circle display-4"></i>
                            <p class="mt-3">Select organizations from the left panel and click "Compare Selected" to view licensing comparison.</p>
                        </div>
                        <div id="comparisonLoading" class="text-center py-5 d-none">
                            <div class="spinner-border spinner-magenta" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Fetching license data...</p>
                        </div>
                        <div id="comparisonResults" class="d-none">
                            <div class="table-responsive">
                                <table class="table table-hover comparison-table" id="comparisonTable">
                                    <thead>
                                        <tr id="tableHeader">
                                            <!-- Headers populated dynamically -->
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <!-- Data populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="comparisonError" class="alert alert-danger d-none">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="comparisonErrorMessage"></span>
                        </div>
                    </div>
                </div>

                <!-- Purchased Licenses Input -->
                <div id="purchasedLicensesCard" class="card mt-4 d-none">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-calculator me-2"></i>Purchased Licenses (Optional)</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="clearPurchasedLicenses()">
                            <i class="bi bi-x-circle me-1"></i>Clear
                        </button>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Enter purchased license counts to calculate remaining (unused) licenses. SUB-AI includes: MAN, VNA, AST, ENG, PMA.</p>
                        <div class="row g-2" id="purchasedInputs">
                            <!-- Inputs populated dynamically -->
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-magenta" onclick="calculateRemaining()">
                                <i class="bi bi-calculator me-1"></i>Calculate Remaining
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div id="summaryCards" class="row mt-4 d-none">
                    <!-- Summary cards populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State
        let organizations = [];
        let selectedOrgs = new Set();
        let comparisonData = [];
        let purchasedLicenses = {};
        let lastLicenseTotals = {};
        let lastSortedLicenseTypes = [];
        let manualOrgs = []; // Stores manually entered org data
        let manualOrgCounter = 0; // Counter for unique manual org IDs

        // License type descriptions for tooltips
        // ✓ = From official Juniper Mist documentation
        // ⚠ = Inferred/guessed based on naming convention
        const licenseDescriptions = {
            // Wireless - Documented
            'SUB-MAN': '✓ Wireless Management - Basic AP management and monitoring',
            'SUB-VNA': '✓ Virtual Network Assistant - AI-driven wireless insights, anomaly detection, and RCA',
            'SUB-AST': '✓ Asset Visibility - BLE-based asset tracking and location services',
            'SUB-ENG': '✓ Engagement Analytics - User engagement, dwell time, and proximity analytics',
            'SUB-PMA': '✓ Premium Analytics - Advanced network analytics and reporting',
            'SUB-AI': '✓ Mist AI Bundle - Includes MAN, VNA, AST, ENG, and PMA subscriptions',
            
            // Wired - Documented
            'SUB-EX12': '✓ EX Switch (12 port) - Wired Assurance for 12-port EX switches',
            'SUB-EX24': '✓ EX Switch (24 port) - Wired Assurance for 24-port EX switches',
            'SUB-EX48': '✓ EX Switch (48 port) - Wired Assurance for 48-port EX switches',
            'SUB-EX-VNA': '✓ EX Switch VNA - Virtual Network Assistant for EX switches',
            'SUB-SVNA': '✓ Switch VNA - AI-driven wired insights for all managed switches',
            
            // WAN - Documented
            'SUB-WAN': '✓ WAN Assurance - Management for SSR/SRX WAN edge devices',
            'SUB-WVNA': '✓ WAN VNA - AI-driven WAN insights and anomaly detection',
            
            // Access Assurance - Documented
            'S-CLIENT-S': '✓ Access Assurance Standard - NAC for standard client authentication',
            'S-CLIENT-A': '✓ Access Assurance Advanced - NAC with advanced policy features',
            
            // Inferred/Guessed - NOT in official docs
            'SUB-ME': '✓ Mist Edge - Subscription for Mist Edge appliances',
            'SUB-SSR': '⚠ UNDOCUMENTED - Possibly Session Smart Router subscription',
            'SUB-SPRM2': '⚠ UNDOCUMENTED - Possibly SSR Premium tier 2',
            'SUB-WAN1': '⚠ UNDOCUMENTED - Possibly WAN tier 1 subscription',
            'SUB-WAN2': '⚠ UNDOCUMENTED - Possibly WAN tier 2 subscription',
            'SUB-WAN3': '⚠ UNDOCUMENTED - Possibly WAN tier 3 subscription',
            'SUB-WAN4': '⚠ UNDOCUMENTED - Possibly WAN tier 4 subscription',
            'SUB-WAN5': '⚠ UNDOCUMENTED - Possibly WAN tier 5 subscription'
        };

        // Get license description for tooltip
        function getLicenseDescription(licType) {
            return licenseDescriptions[licType] || `⚠ ${licType} - Unknown license type (not in documentation)`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshOrganizations();
        });

        // Fetch organizations
        async function refreshOrganizations() {
            document.getElementById('orgLoading').classList.remove('d-none');
            document.getElementById('orgList').classList.add('d-none');
            document.getElementById('orgError').classList.add('d-none');
            
            try {
                const response = await fetch('/api/organizations');
                const result = await response.json();
                
                if (result.success) {
                    organizations = result.data;
                    renderOrganizations();
                    updateConnectionStatus(true);
                } else {
                    throw new Error(result.error || 'Failed to fetch organizations');
                }
            } catch (error) {
                console.error('Error fetching organizations:', error);
                document.getElementById('orgErrorMessage').textContent = error.message;
                document.getElementById('orgError').classList.remove('d-none');
                updateConnectionStatus(false);
            } finally {
                document.getElementById('orgLoading').classList.add('d-none');
            }
        }

        // Render organization list as inline checkboxes
        function renderOrganizations() {
            const list = document.getElementById('orgList');
            list.innerHTML = '';
            
            organizations.forEach(org => {
                const item = document.createElement('div');
                item.className = 'form-check form-check-inline';
                item.dataset.orgId = org.id;
                
                item.innerHTML = `
                    <input class="form-check-input org-checkbox" type="checkbox" 
                           id="org-${org.id}" onchange="toggleOrg('${org.id}')">
                    <label class="form-check-label" for="org-${org.id}">
                        ${org.name} <span class="badge bg-secondary">${org.role}</span>
                    </label>
                `;
                
                list.appendChild(item);
            });
            
            list.classList.remove('d-none');
        }

        // Toggle organization selection
        function toggleOrg(orgId) {
            const checkbox = document.getElementById(`org-${orgId}`);
            
            if (checkbox.checked) {
                selectedOrgs.add(orgId);
            } else {
                selectedOrgs.delete(orgId);
            }
            
            updateSelectedCount();
        }

        // Select all organizations
        function selectAllOrgs() {
            organizations.forEach(org => {
                const checkbox = document.getElementById(`org-${org.id}`);
                if (checkbox && !checkbox.checked) {
                    checkbox.checked = true;
                    selectedOrgs.add(org.id);
                }
            });
            updateSelectedCount();
        }

        // Update selected count
        function updateSelectedCount() {
            const count = selectedOrgs.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('compareBtn').disabled = count < 1;
        }

        // Compare selected organizations
        async function compareSelected() {
            if (selectedOrgs.size === 0) return;
            
            document.getElementById('comparisonPlaceholder').classList.add('d-none');
            document.getElementById('comparisonLoading').classList.remove('d-none');
            document.getElementById('comparisonResults').classList.add('d-none');
            document.getElementById('comparisonError').classList.add('d-none');
            document.getElementById('summaryCards').classList.add('d-none');
            
            try {
                const response = await fetch('/api/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ org_ids: Array.from(selectedOrgs) })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    comparisonData = result.data;
                    renderComparison();
                    document.getElementById('exportBtn').disabled = false;
                } else {
                    throw new Error(result.error || 'Failed to compare organizations');
                }
            } catch (error) {
                console.error('Error comparing organizations:', error);
                document.getElementById('comparisonErrorMessage').textContent = error.message;
                document.getElementById('comparisonError').classList.remove('d-none');
            } finally {
                document.getElementById('comparisonLoading').classList.add('d-none');
            }
        }

        // Render comparison table - orgs as rows, metrics as columns
        function renderComparison() {
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            
            // Collect all license types from entitled, summary, AND amendments
            const licenseTypes = new Set();
            comparisonData.forEach(org => {
                if (org.licenses) {
                    // From entitled (entitlement counts)
                    if (org.licenses.entitled) {
                        Object.keys(org.licenses.entitled).forEach(key => licenseTypes.add(key));
                    }
                    // From summary (usage counts)
                    if (org.licenses.summary) {
                        Object.keys(org.licenses.summary).forEach(key => licenseTypes.add(key));
                    }
                    // From amendments (individual license records)
                    if (org.licenses.amendments && Array.isArray(org.licenses.amendments)) {
                        org.licenses.amendments.forEach(amendment => {
                            if (amendment.type) {
                                licenseTypes.add(amendment.type);
                            }
                        });
                    }
                }
            });
            const sortedLicenseTypes = Array.from(licenseTypes).sort();
            
            // Build header: Organization | APs | Switches | Gateways | Total | License1 | License2 | ...
            header.innerHTML = '<th>Organization</th><th>APs</th><th>Switches</th><th>Gateways</th><th>Total Devices</th>';
            sortedLicenseTypes.forEach(licType => {
                const desc = getLicenseDescription(licType);
                header.innerHTML += `<th data-bs-toggle="tooltip" data-bs-placement="top" title="${desc}" style="cursor: help;">${licType}</th>`;
            });
            
            // Initialize Bootstrap tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
            
            // Build body - one row per org
            body.innerHTML = '';
            
            // Totals accumulators
            let totalAPs = 0, totalSwitches = 0, totalGateways = 0, totalDevices = 0;
            const licenseTotals = {};
            sortedLicenseTypes.forEach(lt => {
                licenseTotals[lt] = { entitled: 0, used: 0 };
            });
            
            // Add row for each organization
            comparisonData.forEach(org => {
                const aps = org.inventory?.aps || 0;
                const switches = org.inventory?.switches || 0;
                const gateways = org.inventory?.gateways || 0;
                const total = org.inventory?.total || 0;
                
                totalAPs += aps;
                totalSwitches += switches;
                totalGateways += gateways;
                totalDevices += total;
                
                let tr = `<tr>`;
                tr += `<td><strong>${org.org_name}</strong></td>`;
                tr += `<td>${aps.toLocaleString()}</td>`;
                tr += `<td>${switches.toLocaleString()}</td>`;
                tr += `<td>${gateways.toLocaleString()}</td>`;
                tr += `<td>${total.toLocaleString()}</td>`;
                
                // License columns
                sortedLicenseTypes.forEach(licType => {
                    const entitled = (org.licenses?.entitled && org.licenses.entitled[licType]) || 0;
                    const used = (org.licenses?.summary && org.licenses.summary[licType]) || 0;
                    licenseTotals[licType].entitled += entitled;
                    licenseTotals[licType].used += used;
                    
                    if (entitled > 0 || used > 0) {
                        tr += `<td>${used.toLocaleString()} / ${entitled.toLocaleString()}</td>`;
                    } else {
                        tr += `<td>-</td>`;
                    }
                });
                
                tr += '</tr>';
                body.innerHTML += tr;
            });
            
            // Add totals row
            let totalsRow = `<tr class="license-type-header">`;
            totalsRow += `<td><strong>TOTAL</strong></td>`;
            totalsRow += `<td><strong>${totalAPs.toLocaleString()}</strong></td>`;
            totalsRow += `<td><strong>${totalSwitches.toLocaleString()}</strong></td>`;
            totalsRow += `<td><strong>${totalGateways.toLocaleString()}</strong></td>`;
            totalsRow += `<td><strong>${totalDevices.toLocaleString()}</strong></td>`;
            
            sortedLicenseTypes.forEach(licType => {
                const lt = licenseTotals[licType];
                if (lt.entitled > 0 || lt.used > 0) {
                    totalsRow += `<td><strong>${lt.used.toLocaleString()} / ${lt.entitled.toLocaleString()}</strong></td>`;
                } else {
                    totalsRow += `<td>-</td>`;
                }
            });
            totalsRow += '</tr>';
            body.innerHTML += totalsRow;
            
            // Save for remaining calculation
            lastLicenseTotals = licenseTotals;
            lastSortedLicenseTypes = sortedLicenseTypes;
            
            // Show purchased licenses input card and populate inputs
            renderPurchasedInputs(sortedLicenseTypes);
            
            document.getElementById('comparisonResults').classList.remove('d-none');
            renderSummaryCards();
        }

        // Render summary cards
        function renderSummaryCards() {
            const container = document.getElementById('summaryCards');
            container.innerHTML = '';
            
            let totalAPs = 0, totalSwitches = 0, totalGateways = 0;
            
            comparisonData.forEach(org => {
                if (org.inventory) {
                    totalAPs += org.inventory.aps || 0;
                    totalSwitches += org.inventory.switches || 0;
                    totalGateways += org.inventory.gateways || 0;
                }
            });
            
            const cards = [
                { label: 'Total APs', value: totalAPs, icon: 'bi-wifi' },
                { label: 'Total Switches', value: totalSwitches, icon: 'bi-hdd-stack' },
                { label: 'Total Gateways', value: totalGateways, icon: 'bi-router' },
                { label: 'Organizations', value: comparisonData.length, icon: 'bi-building' }
            ];
            
            cards.forEach(card => {
                container.innerHTML += `
                    <div class="col-md-3">
                        <div class="card license-card">
                            <div class="card-body text-center">
                                <i class="bi ${card.icon} display-4 text-magenta"></i>
                                <h2 class="mt-2">${card.value.toLocaleString()}</h2>
                                <p class="text-muted mb-0">${card.label}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.classList.remove('d-none');
        }

        // Add a manual org row with editable fields
        function addManualOrgRow() {
            // Make sure comparison results are visible
            document.getElementById('comparisonPlaceholder').classList.add('d-none');
            document.getElementById('comparisonResults').classList.remove('d-none');
            
            const body = document.getElementById('tableBody');
            const header = document.getElementById('tableHeader');
            
            // If no header exists yet, create a basic one
            if (!header.innerHTML || header.innerHTML.trim() === '') {
                header.innerHTML = '<th>Organization</th><th>APs</th><th>Switches</th><th>Gateways</th><th>Total Devices</th>';
                // Add common license types if none exist
                const defaultLicTypes = ['SUB-MAN', 'SUB-VNA', 'SUB-AST', 'SUB-ENG', 'SUB-PMA', 'SUB-EX48', 'SUB-SVNA', 'SUB-WAN', 'SUB-WVNA'];
                defaultLicTypes.forEach(licType => {
                    const desc = getLicenseDescription(licType);
                    header.innerHTML += `<th data-bs-toggle="tooltip" data-bs-placement="top" title="${desc}" style="cursor: help;">${licType}</th>`;
                });
                lastSortedLicenseTypes = defaultLicTypes;
                // Initialize tooltips
                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
            }
            
            manualOrgCounter++;
            const manualId = `manual-${manualOrgCounter}`;
            
            // Get license types from header
            const headerCells = header.querySelectorAll('th');
            const licenseTypes = [];
            for (let i = 5; i < headerCells.length; i++) {
                licenseTypes.push(headerCells[i].textContent.trim());
            }
            
            // Create editable row
            let tr = document.createElement('tr');
            tr.id = manualId;
            tr.className = 'manual-org-row';
            tr.style.backgroundColor = '#2a2a3d';
            
            // Org name (editable)
            tr.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <input type="text" class="form-control form-control-sm me-2" 
                               id="${manualId}-name" placeholder="Org Name" 
                               style="width: 120px;" value="Manual Org ${manualOrgCounter}"
                               onchange="recalculateTotals()">
                        <button class="btn btn-sm btn-outline-danger" onclick="removeManualOrg('${manualId}')" title="Remove">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
                <td><input type="number" class="form-control form-control-sm" id="${manualId}-aps" 
                           placeholder="0" min="0" style="width: 70px;" onchange="recalculateTotals()"></td>
                <td><input type="number" class="form-control form-control-sm" id="${manualId}-switches" 
                           placeholder="0" min="0" style="width: 70px;" onchange="recalculateTotals()"></td>
                <td><input type="number" class="form-control form-control-sm" id="${manualId}-gateways" 
                           placeholder="0" min="0" style="width: 70px;" onchange="recalculateTotals()"></td>
                <td><input type="number" class="form-control form-control-sm" id="${manualId}-total" 
                           placeholder="0" min="0" style="width: 70px;" onchange="recalculateTotals()"></td>
            `;
            
            // Add license columns with usage/entitled format
            licenseTypes.forEach(licType => {
                tr.innerHTML += `
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               id="${manualId}-${licType}" placeholder="0/0" 
                               style="width: 80px;" pattern="\\d+/\\d+"
                               title="Format: usage/entitled (e.g., 100/150)"
                               onchange="recalculateTotals()">
                    </td>
                `;
            });
            
            // Insert before totals row (or at end if no totals)
            const totalsRow = body.querySelector('.license-type-header');
            if (totalsRow) {
                body.insertBefore(tr, totalsRow);
            } else {
                body.appendChild(tr);
            }
            
            // Store manual org reference
            manualOrgs.push({ id: manualId, licenseTypes: licenseTypes });
            
            // Recalculate totals
            recalculateTotals();
            
            // Enable export button
            document.getElementById('exportBtn').disabled = false;
            
            // Show purchased licenses card if hidden
            document.getElementById('purchasedLicensesCard').classList.remove('d-none');
            renderPurchasedInputs(licenseTypes.length > 0 ? licenseTypes : lastSortedLicenseTypes);
        }

        // Remove a manual org row
        function removeManualOrg(manualId) {
            const row = document.getElementById(manualId);
            if (row) row.remove();
            manualOrgs = manualOrgs.filter(o => o.id !== manualId);
            recalculateTotals();
        }

        // Parse "usage/entitled" format, returns {used, entitled}
        function parseUsageEntitled(value) {
            if (!value || value.trim() === '') return { used: 0, entitled: 0 };
            const parts = value.split('/');
            if (parts.length === 2) {
                return {
                    used: parseInt(parts[0].trim()) || 0,
                    entitled: parseInt(parts[1].trim()) || 0
                };
            }
            // If just a number, treat as both used and entitled
            const num = parseInt(value.trim()) || 0;
            return { used: num, entitled: num };
        }

        // Recalculate totals including manual orgs
        function recalculateTotals() {
            const body = document.getElementById('tableBody');
            const header = document.getElementById('tableHeader');
            
            // Get license types from header
            const headerCells = header.querySelectorAll('th');
            const licenseTypes = [];
            for (let i = 5; i < headerCells.length; i++) {
                licenseTypes.push(headerCells[i].textContent.trim());
            }
            
            // Initialize totals from API data
            let totalAPs = 0, totalSwitches = 0, totalGateways = 0, totalDevices = 0;
            const licenseTotals = {};
            licenseTypes.forEach(lt => {
                licenseTotals[lt] = { entitled: 0, used: 0 };
            });
            
            // Add API org data
            comparisonData.forEach(org => {
                totalAPs += org.inventory?.aps || 0;
                totalSwitches += org.inventory?.switches || 0;
                totalGateways += org.inventory?.gateways || 0;
                totalDevices += org.inventory?.total || 0;
                
                licenseTypes.forEach(licType => {
                    const entitled = (org.licenses?.entitled && org.licenses.entitled[licType]) || 0;
                    const used = (org.licenses?.summary && org.licenses.summary[licType]) || 0;
                    licenseTotals[licType].entitled += entitled;
                    licenseTotals[licType].used += used;
                });
            });
            
            // Add manual org data
            manualOrgs.forEach(manualOrg => {
                const id = manualOrg.id;
                totalAPs += parseInt(document.getElementById(`${id}-aps`)?.value) || 0;
                totalSwitches += parseInt(document.getElementById(`${id}-switches`)?.value) || 0;
                totalGateways += parseInt(document.getElementById(`${id}-gateways`)?.value) || 0;
                totalDevices += parseInt(document.getElementById(`${id}-total`)?.value) || 0;
                
                licenseTypes.forEach(licType => {
                    const input = document.getElementById(`${id}-${licType}`);
                    if (input) {
                        const parsed = parseUsageEntitled(input.value);
                        licenseTotals[licType].used += parsed.used;
                        licenseTotals[licType].entitled += parsed.entitled;
                    }
                });
            });
            
            // Update or create totals row
            let totalsRow = body.querySelector('.license-type-header');
            if (!totalsRow) {
                totalsRow = document.createElement('tr');
                totalsRow.className = 'license-type-header';
                body.appendChild(totalsRow);
            }
            
            totalsRow.innerHTML = `
                <td><strong>TOTAL</strong></td>
                <td><strong>${totalAPs.toLocaleString()}</strong></td>
                <td><strong>${totalSwitches.toLocaleString()}</strong></td>
                <td><strong>${totalGateways.toLocaleString()}</strong></td>
                <td><strong>${totalDevices.toLocaleString()}</strong></td>
            `;
            
            licenseTypes.forEach(licType => {
                const lt = licenseTotals[licType];
                if (lt.entitled > 0 || lt.used > 0) {
                    totalsRow.innerHTML += `<td><strong>${lt.used.toLocaleString()} / ${lt.entitled.toLocaleString()}</strong></td>`;
                } else {
                    totalsRow.innerHTML += `<td>-</td>`;
                }
            });
            
            // Update saved totals for remaining calculation
            lastLicenseTotals = licenseTotals;
            lastSortedLicenseTypes = licenseTypes;
        }

        // Export to CSV - exports the full table as displayed
        function exportCSV() {
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            
            if (!header || !body) return;
            
            // Get header columns
            const headerCells = header.querySelectorAll('th');
            const headers = [];
            headerCells.forEach(th => {
                headers.push(th.textContent.trim().replace(/\n/g, ' '));
            });
            
            let csv = headers.map(h => `"${h}"`).join(',') + '\n';
            
            // Get all rows from tbody
            const rows = body.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                cells.forEach((td, idx) => {
                    // Check if cell contains an input
                    const input = td.querySelector('input');
                    let text;
                    if (input) {
                        text = input.value || '';
                    } else {
                        // Get text content, clean it up
                        text = td.textContent.trim().replace(/\n/g, ' ').replace(/\s+/g, ' ');
                    }
                    // Prefix with space to prevent Excel date interpretation (e.g., "10/50" -> date)
                    // Skip first column (org name) which won't be misinterpreted
                    if (idx > 0 && text.includes('/')) {
                        text = ' ' + text;
                    }
                    rowData.push(`"${text}"`);
                });
                
                if (rowData.length > 0) {
                    csv += rowData.join(',') + '\n';
                }
            });
            
            // Create and trigger download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mist_license_comparison_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'badge bg-success me-3';
                status.innerHTML = '<i class="bi bi-circle-fill me-1"></i>Connected';
            } else {
                status.className = 'badge bg-danger me-3';
                status.innerHTML = '<i class="bi bi-circle-fill me-1"></i>Disconnected';
            }
        }

        // Render purchased licenses input fields
        function renderPurchasedInputs(licenseTypes) {
            const container = document.getElementById('purchasedInputs');
            container.innerHTML = '';
            
            // Add SUB-AI input first (it's a bundle)
            container.innerHTML += `
                <div class="col-md-3 col-sm-6">
                    <label class="form-label small text-magenta"><strong>SUB-AI (Bundle)</strong></label>
                    <input type="number" class="form-control form-control-sm" id="purchased-SUB-AI" 
                           placeholder="0" min="0" value="${purchasedLicenses['SUB-AI'] || ''}"
                           onchange="updatePurchased('SUB-AI', this.value)">
                    <small class="text-muted">Includes MAN, VNA, AST, ENG, PMA</small>
                </div>
            `;
            
            // Add inputs for each license type
            licenseTypes.forEach(licType => {
                container.innerHTML += `
                    <div class="col-md-2 col-sm-4">
                        <label class="form-label small">${licType}</label>
                        <input type="number" class="form-control form-control-sm" id="purchased-${licType}" 
                               placeholder="0" min="0" value="${purchasedLicenses[licType] || ''}"
                               onchange="updatePurchased('${licType}', this.value)">
                    </div>
                `;
            });
            
            document.getElementById('purchasedLicensesCard').classList.remove('d-none');
        }

        // Update purchased value
        function updatePurchased(licType, value) {
            const num = parseInt(value) || 0;
            if (num > 0) {
                purchasedLicenses[licType] = num;
            } else {
                delete purchasedLicenses[licType];
            }
        }

        // Clear all purchased licenses
        function clearPurchasedLicenses() {
            purchasedLicenses = {};
            document.querySelectorAll('#purchasedInputs input').forEach(input => {
                input.value = '';
            });
            // Remove remaining row if exists
            const remainingRow = document.getElementById('remainingRow');
            if (remainingRow) remainingRow.remove();
        }

        // Calculate and display remaining licenses
        function calculateRemaining() {
            const body = document.getElementById('tableBody');
            
            // Remove existing remaining row
            const existingRow = document.getElementById('remainingRow');
            if (existingRow) existingRow.remove();
            
            // SUB-AI bundle components
            const subAiComponents = ['SUB-MAN', 'SUB-VNA', 'SUB-AST', 'SUB-ENG', 'SUB-PMA'];
            const subAiCount = purchasedLicenses['SUB-AI'] || 0;
            
            let hasAnyPurchased = Object.keys(purchasedLicenses).length > 0;
            
            if (!hasAnyPurchased) {
                alert('Please enter at least one purchased license count.');
                return;
            }
            
            // Build remaining row using DOM (not innerHTML) to preserve other elements
            const remainingRowEl = document.createElement('tr');
            remainingRowEl.id = 'remainingRow';
            remainingRowEl.style.backgroundColor = '#1a3a1a';
            remainingRowEl.style.borderTop = '2px solid var(--tmobile-magenta)';
            
            remainingRowEl.innerHTML = `
                <td><strong><i class="bi bi-box-arrow-down me-1"></i>REMAINING (Purchased - Entitled)</strong></td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            `;
            
            lastSortedLicenseTypes.forEach(licType => {
                const lt = lastLicenseTotals[licType] || { used: 0, entitled: 0 };
                
                // Calculate total purchased for this type
                let purchased = purchasedLicenses[licType] || 0;
                
                // Add SUB-AI contribution if this is a component
                if (subAiComponents.includes(licType)) {
                    purchased += subAiCount;
                }
                
                const td = document.createElement('td');
                if (purchased > 0) {
                    // Use ENTITLED (not used) - remaining = purchased - total entitled across orgs
                    const remaining = purchased - lt.entitled;
                    const colorClass = remaining >= 0 ? 'text-success' : 'text-danger';
                    const icon = remaining >= 0 ? 'bi-check-circle' : 'bi-exclamation-triangle';
                    td.className = colorClass;
                    td.innerHTML = `<strong><i class="bi ${icon} me-1"></i>${remaining.toLocaleString()}</strong>`;
                } else {
                    td.className = 'text-muted';
                    td.textContent = '-';
                }
                remainingRowEl.appendChild(td);
            });
            
            // Append to body (after totals row)
            body.appendChild(remainingRowEl);
        }
    </script>
</body>
</html>
